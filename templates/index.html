{% extends "base.html" %}
{% block content %}
<div class="page-wrapper"> 
	<h1>Shuttle Invaders Leaderboard</h1>
	<div id="playerscores-container">
		<p>Loading...</p>
	</div>
	<div>
		<h2> Information </h2>
	<p> Shuttle Invaders is a game where you get to play as a spaceship and shoot unwraps and errors away.</p>
	
	<p> Interested in getting to know us more? </p>
	<p><a href="https://www.github.com/shuttle-hq/shuttle" target="_blank">Give us a star on GitHub!</a></p>
	<p><a href="https://www.twitter.com/shuttle_dev" target="_blank"> Follow us on Twitter for updates on releases! </a></p>
	</div>
</div>

<script>
async function fetchScoresJSON() {
	let host = window.location.protocol !== 'https:' ? 'http://localhost:8000' : 'https://shuttlegame-leaderboard.shuttleapp.rs';

	const response = await fetch( host + "/scores");
	const data = response.json();
	return data;
}

fetchScoresJSON()
	.then(response => {
if (response.length > 0) {
	redrawScores(response);
	}
})

try {
const eventsource = new EventSource("//localhost:8000/ws");

eventsource.onmessage = (event) => {
  let event_data = JSON.parse(event.data);
  console.log("Received some data: ", event_data);
 if  (event_data.length > 0) {
	 redrawScores(event_data);
	}
};
} catch(e) {
	console.log(e.message)
}

function redrawScores(array) {
	let elems = array.map((x, i) => {
	let meme = document.createElement("div");
	meme.classList.toggle("playerscore-container");
	meme.innerText = (i + 1) + ". " + x.score + " - " + x.name;
	
	return meme
	});

let meme = document.querySelector("#playerscores-container");
meme.replaceChildren(...elems);
}
</script>
{% endblock content %}
